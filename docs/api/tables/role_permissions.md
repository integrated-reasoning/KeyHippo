# role_permissions

Maps roles to their assigned permissions.

## Schema

```sql
CREATE TABLE keyhippo_rbac.role_permissions (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    role_id uuid NOT NULL REFERENCES keyhippo_rbac.roles(id) ON DELETE CASCADE,
    permission_id uuid NOT NULL REFERENCES keyhippo_rbac.permissions(id) ON DELETE CASCADE,
    UNIQUE(role_id, permission_id)
);
```

## Columns

| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| role_id | uuid | Role reference |
| permission_id | uuid | Permission reference |

## Indexes

- Primary Key on `id`
- Unique index on `(role_id, permission_id)`
- Index on `role_id`
- Index on `permission_id`

## Security

- RLS enabled
- Requires manage_roles permission
- Audit logged
- Core RBAC table

## Example Usage

### Assign Permission
```sql
INSERT INTO keyhippo_rbac.role_permissions (role_id, permission_id)
SELECT 
    'role_id_here',
    id
FROM keyhippo_rbac.permissions
WHERE name = 'manage_users';
```

### Bulk Assignment
```sql
DO $$
DECLARE
    role_id uuid;
BEGIN
    -- Get role
    SELECT id INTO role_id
    FROM keyhippo_rbac.roles
    WHERE name = 'Admin Role';
    
    -- Assign all permissions
    INSERT INTO keyhippo_rbac.role_permissions (role_id, permission_id)
    SELECT 
        role_id,
        id
    FROM keyhippo_rbac.permissions
    ON CONFLICT (role_id, permission_id) DO NOTHING;
END $$;
```

### Query Role Permissions
```sql
SELECT 
    r.name as role_name,
    array_agg(p.name) as permissions
FROM keyhippo_rbac.roles r
JOIN keyhippo_rbac.role_permissions rp ON r.id = rp.role_id
JOIN keyhippo_rbac.permissions p ON rp.permission_id = p.id
GROUP BY r.id, r.name;
```

## Implementation Notes

1. **Access Control**
```sql
-- RLS policy
CREATE POLICY role_permissions_access_policy ON keyhippo_rbac.role_permissions
    FOR ALL
    TO authenticated
    USING (keyhippo.authorize('manage_roles'))
    WITH CHECK (keyhippo.authorize('manage_roles'));
```

2. **Cascading Deletes**
```sql
-- When role is deleted:
ON DELETE CASCADE

-- When permission is deleted:
ON DELETE CASCADE
```

3. **Identity Column**
```sql
-- Auto-incrementing ID
GENERATED BY DEFAULT AS IDENTITY
```

## Common Patterns

1. **Basic Role Setup**
```sql
DO $$
DECLARE
    role_id uuid;
BEGIN
    -- Create role
    INSERT INTO keyhippo_rbac.roles (name, group_id, role_type)
    VALUES ('Team Lead', 'group_id_here', 'admin')
    RETURNING id INTO role_id;
    
    -- Assign permissions
    INSERT INTO keyhippo_rbac.role_permissions (role_id, permission_id)
    SELECT role_id, id
    FROM keyhippo_rbac.permissions
    WHERE name IN (
        'manage_team',
        'manage_resources',
        'view_analytics'
    );
END $$;
```

2. **Permission Copy**
```sql
-- Copy permissions from one role to another
INSERT INTO keyhippo_rbac.role_permissions (role_id, permission_id)
SELECT 
    'new_role_id_here',
    permission_id
FROM keyhippo_rbac.role_permissions
WHERE role_id = 'template_role_id_here'
ON CONFLICT (role_id, permission_id) DO NOTHING;
```

## Performance Considerations

1. **Efficient Lookups**
```sql
-- Use EXISTS for performance
SELECT EXISTS (
    SELECT 1
    FROM keyhippo_rbac.role_permissions rp
    WHERE rp.role_id = 'role_id_here'
    AND rp.permission_id = 'permission_id_here'
);
```

2. **Batch Operations**
```sql
-- Bulk revoke
DELETE FROM keyhippo_rbac.role_permissions
WHERE role_id = 'role_id_here'
AND permission_id IN (
    SELECT id FROM keyhippo_rbac.permissions
    WHERE name = ANY(ARRAY['perm1', 'perm2'])
);
```

## Related Tables

- [roles](roles.md)
- [permissions](permissions.md)
- [user_group_roles](user_group_roles.md)

## See Also

- [assign_permission_to_role()](../functions/assign_permission_to_role.md)
- [authorize()](../functions/authorize.md)
- [RBAC Security](../security/rls_policies.md)